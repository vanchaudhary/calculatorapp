name: Enhanced CI/CD - Multi-Environment Docker Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  APP_NAME: calculator-app
  STAGING_PORT: 3002
  PRODUCTION_PORT: 3000

jobs:
  ci-cd-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    # ========== CI PHASE ==========
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Build Docker Image
      run: |
        echo "ðŸ”¨ Building Docker image with tag: ${{ github.sha }}"
        docker build -t ${{ env.APP_NAME }}:${{ github.sha }} .
        docker build -t ${{ env.APP_NAME }}:latest .
        echo "âœ… Build completed successfully"

    - name: ðŸ§ª Run Automated Tests
      run: |
        echo "ðŸ§ª Starting automated testing..."
        
        # Start test container
        docker run -d -p 3001:3000 --name test-container ${{ env.APP_NAME }}:${{ github.sha }}
        
        # Wait for app to start
        echo "â³ Waiting for application to start..."
        sleep 12
        
        # Check if container is running
        echo "ðŸ” Checking container status..."
        docker ps --filter "name=test-container"
        
        # Check container logs
        echo "ðŸ“‹ Container logs:"
        docker logs test-container
        
        # Run health check with retry logic
        echo "ðŸ” Running health checks..."
        for i in {1..5}; do
          echo "Health check attempt $i/5..."
          if curl -f http://localhost:3001; then
            echo "âœ… Health check passed"
            break
          else
            echo "âš ï¸ Health check attempt $i failed, retrying..."
            sleep 3
            if [ $i -eq 5 ]; then
              echo "âŒ Health check failed after 5 attempts"
              docker logs test-container
              docker stop test-container || true
              docker rm test-container || true
              exit 1
            fi
          fi
        done
        
        # Simple functionality test
        echo "ðŸ§® Testing calculator functionality..."
        response=$(curl -s http://localhost:3001 || echo "failed")
        if echo "$response" | grep -q "Calculator"; then
          echo "âœ… Calculator app is responding correctly"
        else
          echo "âŒ Calculator test failed - unexpected response"
          echo "Response: $response"
          docker logs test-container
        fi
        
        # Cleanup test container
        docker stop test-container || true
        docker rm test-container || true
        echo "âœ… All tests completed!"

    # ========== CD PHASE ==========
    - name: ðŸŸ¡ Deploy to Staging Environment
      run: |
        echo "ðŸš€ Deploying to STAGING environment..."
        
        # Stop existing staging container if running
        docker stop staging-${{ env.APP_NAME }} 2>/dev/null || true
        docker rm staging-${{ env.APP_NAME }} 2>/dev/null || true
        
        # Deploy to staging
        docker run -d -p ${{ env.STAGING_PORT }}:3000 --name staging-${{ env.APP_NAME }} ${{ env.APP_NAME }}:${{ github.sha }}
        
        # Wait and verify staging deployment
        sleep 8
        echo "ðŸ” Verifying staging deployment..."
        
        for i in {1..3}; do
          if curl -f http://localhost:${{ env.STAGING_PORT }}; then
            echo "âœ… STAGING deployment verified!"
            break
          else
            echo "âš ï¸ Staging verification attempt $i failed, retrying..."
            sleep 3
            if [ $i -eq 3 ]; then
              echo "âŒ Staging deployment verification failed"
              docker logs staging-${{ env.APP_NAME }}
              exit 1
            fi
          fi
        done
        
        echo "ðŸŒ Staging URL: http://localhost:${{ env.STAGING_PORT }}"

    - name: ðŸ” Staging Smoke Tests
      run: |
        echo "ðŸ”¬ Running staging smoke tests..."
        
        # Test main page
        echo "Testing main page..."
        if curl -f http://localhost:${{ env.STAGING_PORT }} > /dev/null; then
          echo "âœ… Main page test passed"
        else
          echo "âŒ Main page test failed"
          docker logs staging-${{ env.APP_NAME }}
          exit 1
        fi
        
        # Simple response test
        response=$(curl -s http://localhost:${{ env.STAGING_PORT }} || echo "failed")
        if echo "$response" | grep -q "Calculator"; then
          echo "âœ… Staging smoke tests passed - app is responding correctly"
        else
          echo "âŒ Staging smoke tests failed - unexpected response"
          echo "Response: $response"
          exit 1
        fi

    - name: ðŸŸ¢ Deploy to Production Environment
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸš€ Deploying to PRODUCTION environment..."
        
        # Backup current production (if exists)
        if docker ps --filter "name=production-${{ env.APP_NAME }}" --format "table {{.Names}}" | grep -q "production-${{ env.APP_NAME }}"; then
          echo "ðŸ“¦ Creating backup of current production..."
          docker tag production-${{ env.APP_NAME }} ${{ env.APP_NAME }}:backup-$(date +%Y%m%d-%H%M%S)
        fi
        
        # Stop existing production container
        docker stop production-${{ env.APP_NAME }} 2>/dev/null || true
        docker rm production-${{ env.APP_NAME }} 2>/dev/null || true
        
        # Deploy to production
        docker run -d -p ${{ env.PRODUCTION_PORT }}:3000 --name production-${{ env.APP_NAME }} ${{ env.APP_NAME }}:${{ github.sha }}
        
        # Wait and verify production deployment
        sleep 5
        curl --fail http://localhost:${{ env.PRODUCTION_PORT }} || (echo "âŒ Production deployment failed" && exit 1)
        
        echo "âœ… PRODUCTION deployment successful!"
        echo "ðŸŒ Production URL: http://localhost:${{ env.PRODUCTION_PORT }}"

    - name: ðŸŽ¯ Production Health Check
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ¥ Running production health checks..."
        
        # Comprehensive health check
        for i in {1..3}; do
          echo "ðŸ” Health check attempt $i/3..."
          if curl --fail http://localhost:${{ env.PRODUCTION_PORT }} > /dev/null; then
            echo "âœ… Production health check $i passed"
          else
            echo "âŒ Production health check $i failed"
            if [ $i -eq 3 ]; then exit 1; fi
          fi
          sleep 2
        done
        
        echo "ðŸŽ‰ Production deployment verified and healthy!"

    - name: ðŸ§¹ Cleanup Staging Environment
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ§¹ Cleaning up staging environment..."
        docker stop staging-${{ env.APP_NAME }} 2>/dev/null || true
        docker rm staging-${{ env.APP_NAME }} 2>/dev/null || true
        echo "âœ… Staging cleanup completed"

    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo "========================================"
        echo "ðŸŽ¯ DEPLOYMENT SUMMARY"
        echo "========================================"
        echo "ðŸ“¦ Image Tag: ${{ github.sha }}"
        echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ðŸ“… Deploy Time: $(date)"
        
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ðŸŸ¢ Production: http://localhost:${{ env.PRODUCTION_PORT }}"
        else
          echo "ðŸŸ¡ Staging: http://localhost:${{ env.STAGING_PORT }}"
        fi
        
        echo "========================================"
        echo "ðŸš€ CI/CD Pipeline completed successfully!"
        echo "========================================"
