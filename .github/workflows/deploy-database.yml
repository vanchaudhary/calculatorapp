name: Deploy Calculator Database

on:
  push:
    branches: [ main, database-demo ]
    paths: [ 'database/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'database/**' ]

env:
  SQL_SERVER_NAME: calculator-sql-server
  SQL_DATABASE_NAME: calculator-db

jobs:
  validate-database:
    runs-on: ubuntu-latest
    name: ðŸ” Validate Database Schema
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ” Validate SQL Project Structure
      run: |
        echo "ðŸ” Validating database project structure..."
        
        # Check if required files exist
        if [ ! -f "database/Calculator.sqlproj" ]; then
          echo "âŒ Calculator.sqlproj not found"
          exit 1
        fi
        
        if [ ! -f "database/Tables/Users.sql" ]; then
          echo "âŒ Users.sql not found"
          exit 1
        fi
        
        if [ ! -f "database/Tables/Calculations.sql" ]; then
          echo "âŒ Calculations.sql not found"  
          exit 1
        fi
        
        echo "âœ… Database project structure is valid"

  deploy-to-staging:
    needs: validate-database
    if: github.ref == 'refs/heads/database-demo'
    runs-on: ubuntu-latest
    name: ðŸš€ Deploy to Staging Database
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸ—„ï¸ Create SQL deployment script
      run: |
        mkdir -p ./sql-scripts
        cat > ./sql-scripts/deploy-schema.sql << 'EOF'
        -- Create Users table if not exists
        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Users' AND xtype='U')
        BEGIN
            CREATE TABLE Users (
                id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
                session_id NVARCHAR(255) UNIQUE NOT NULL,
                created_at DATETIME2 DEFAULT GETDATE()
            );
            PRINT 'Users table created successfully';
        END
        ELSE
        BEGIN
            PRINT 'Users table already exists';
        END
        
        -- Create Calculations table if not exists
        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Calculations' AND xtype='U')
        BEGIN
            CREATE TABLE Calculations (
                id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
                user_id UNIQUEIDENTIFIER REFERENCES Users(id),
                expression NVARCHAR(500) NOT NULL,
                result NVARCHAR(100) NOT NULL,
                created_at DATETIME2 DEFAULT GETDATE()
            );
            PRINT 'Calculations table created successfully';
        END
        ELSE
        BEGIN
            PRINT 'Calculations table already exists';
        END
        
        -- Verify tables exist
        SELECT 
            TABLE_NAME,
            'Table exists' as Status
        FROM INFORMATION_SCHEMA.TABLES 
        WHERE TABLE_SCHEMA = 'dbo' 
        AND TABLE_NAME IN ('Users', 'Calculations');
        EOF
        
    - name: ðŸ—„ï¸ Deploy Database Schema to Staging
      uses: azure/sql-action@v2.3
      with:        
        connection-string: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
        path: './sql-scripts/deploy-schema.sql'
        
    - name: ðŸ§ª Run Database Tests on Staging
      run: echo "âœ… Database deployment to staging completed successfully"

  deploy-to-production:
    needs: validate-database
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    name: ðŸ­ Deploy to Production Database
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ðŸ’¾ Backup Production Database
      run: |
        echo "ðŸ’¾ Creating backup of production database..."
        BACKUP_NAME="calculator-db-backup-$(date +%Y%m%d-%H%M%S)"
        
        az sql db export \
          --server ${{ env.SQL_SERVER_NAME }} \
          --name ${{ env.SQL_DATABASE_NAME }} \
          --admin-user ${{ secrets.SQL_ADMIN_USER }} \
          --admin-password ${{ secrets.SQL_ADMIN_PASSWORD }} \
          --storage-key ${{ secrets.STORAGE_ACCOUNT_KEY }} \
          --storage-key-type StorageAccessKey \
          --storage-uri "https://${{ secrets.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/backups/${BACKUP_NAME}.bacpac" || true
        
        echo "âœ… Backup completed: ${BACKUP_NAME}.bacpac"
    
    - name: ðŸ—„ï¸ Create SQL deployment script  
      run: |
        mkdir -p ./sql-scripts
        cat > ./sql-scripts/deploy-schema.sql << 'EOF'
        -- Create Users table if not exists
        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Users' AND xtype='U')
        BEGIN
            CREATE TABLE Users (
                id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
                session_id NVARCHAR(255) UNIQUE NOT NULL,
                created_at DATETIME2 DEFAULT GETDATE()
            );
            PRINT 'Users table created successfully';
        END
        ELSE
        BEGIN
            PRINT 'Users table already exists';
        END
        
        -- Create Calculations table if not exists
        IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='Calculations' AND xtype='U')
        BEGIN
            CREATE TABLE Calculations (
                id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
                user_id UNIQUEIDENTIFIER REFERENCES Users(id),
                expression NVARCHAR(500) NOT NULL,
                result NVARCHAR(100) NOT NULL,
                created_at DATETIME2 DEFAULT GETDATE()
            );
            PRINT 'Calculations table created successfully';
        END
        ELSE
        BEGIN
            PRINT 'Calculations table already exists';
        END
        EOF
        
    - name: ðŸ—„ï¸ Deploy Database Schema to Production
      uses: azure/sql-action@v2.3
      with:        
        connection-string: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
        path: './sql-scripts/deploy-schema.sql'
        
    - name: âœ… Create verification script
      run: |
        cat > ./sql-scripts/verify-deployment.sql << 'EOF'
        SELECT 
          COUNT(*) as TableCount,
          'Database deployment verified' as Status
        FROM INFORMATION_SCHEMA.TABLES 
        WHERE TABLE_SCHEMA = 'dbo' 
        AND TABLE_NAME IN ('Users', 'Calculations')
        EOF
        
    - name: âœ… Verify Production Deployment
      uses: azure/sql-action@v2.3
      with:        
        connection-string: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
        path: './sql-scripts/verify-deployment.sql'
          
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "========================================"
        echo "ðŸŽ¯ DATABASE DEPLOYMENT COMPLETED"
        echo "========================================"
        echo "ðŸ“¦ Database: ${{ env.SQL_DATABASE_NAME }}"
        echo "ðŸ–¥ï¸ Server: ${{ env.SQL_SERVER_NAME }}"
        echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ðŸ‘¤ Author: ${{ github.actor }}"
        echo "ðŸ“… Time: $(date)"
        echo "âœ… Ready for application deployment!"
        echo "========================================"