name: Deploy Calculator Database

on:
  push:
    branches: [ main, database-demo ]
    paths: [ 'database/**' ]
  pull_request:
    branches: [ main ]
    paths: [ 'database/**' ]

env:
  SQL_SERVER_NAME: calculator-sql-server
  SQL_DATABASE_NAME: calculator-db

jobs:
  validate-database:
    runs-on: ubuntu-latest
    name: ğŸ” Validate Database Schema
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate SQL Project Structure
      run: |
        echo "ğŸ” Validating database project structure..."
        
        # Check if required files exist
        if [ ! -f "database/Calculator.sqlproj" ]; then
          echo "âŒ Calculator.sqlproj not found"
          exit 1
        fi
        
        if [ ! -f "database/Tables/Users.sql" ]; then
          echo "âŒ Users.sql not found"
          exit 1
        fi
        
        if [ ! -f "database/Tables/Calculations.sql" ]; then
          echo "âŒ Calculations.sql not found"  
          exit 1
        fi
        
        echo "âœ… Database project structure is valid"

  deploy-to-staging:
    needs: validate-database
    if: github.ref == 'refs/heads/database-demo'
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Staging Database
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ğŸ—„ï¸ Deploy Database Schema to Staging
      uses: azure/sql-action@v2.3
      with:        
        connection-string: ${{ secrets.AZURE_SQL_STAGING_CONNECTION_STRING }}
        path: './database/Calculator.sqlproj'
        action: 'publish'
        arguments: '/p:DropObjectsNotInSource=false /p:BlockOnPossibleDataLoss=true'
        
    - name: ğŸ§ª Run Database Tests on Staging
      run: echo "âœ… Database deployment to staging completed successfully"

  deploy-to-production:
    needs: validate-database
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    name: ğŸ­ Deploy to Production Database
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ğŸ’¾ Backup Production Database
      run: |
        echo "ğŸ’¾ Creating backup of production database..."
        BACKUP_NAME="calculator-db-backup-$(date +%Y%m%d-%H%M%S)"
        
        az sql db export \
          --server ${{ env.SQL_SERVER_NAME }} \
          --name ${{ env.SQL_DATABASE_NAME }} \
          --admin-user ${{ secrets.SQL_ADMIN_USER }} \
          --admin-password ${{ secrets.SQL_ADMIN_PASSWORD }} \
          --storage-key ${{ secrets.STORAGE_ACCOUNT_KEY }} \
          --storage-key-type StorageAccessKey \
          --storage-uri "https://${{ secrets.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/backups/${BACKUP_NAME}.bacpac" || true
        
        echo "âœ… Backup completed: ${BACKUP_NAME}.bacpac"
    
    - name: ğŸ—„ï¸ Deploy Database Schema to Production
      uses: azure/sql-action@v2.3
      with:        
        connection-string: ${{ secrets.AZURE_SQL_PRODUCTION_CONNECTION_STRING }}
        path: './database/Calculator.sqlproj'
        action: 'publish'
        arguments: '/p:DropObjectsNotInSource=false /p:BlockOnPossibleDataLoss=true'
        
    - name: âœ… Verify Production Deployment
      uses: azure/sql-action@v2.3
      with:        
        connection-string: ${{ secrets.AZURE_SQL_PRODUCTION_CONNECTION_STRING }}
        path: |
          SELECT 
            COUNT(*) as TableCount,
            'Database deployment verified' as Status
          FROM INFORMATION_SCHEMA.TABLES 
          WHERE TABLE_SCHEMA = 'dbo' 
          AND TABLE_NAME IN ('Users', 'Calculations')
          
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "========================================"
        echo "ğŸ¯ DATABASE DEPLOYMENT COMPLETED"
        echo "========================================"
        echo "ğŸ“¦ Database: ${{ env.SQL_DATABASE_NAME }}"
        echo "ğŸ–¥ï¸ Server: ${{ env.SQL_SERVER_NAME }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "ğŸ“… Time: $(date)"
        echo "âœ… Ready for application deployment!"
        echo "========================================"